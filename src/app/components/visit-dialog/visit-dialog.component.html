<div class="dialog-overlay" *ngIf="open" (click)="closeDialog()">
  <mat-card
    class="panel visit-dialog"
    (click)="$event.stopPropagation()"
    role="dialog"
    aria-modal="true"
    [attr.aria-labelledby]="editedVisitId ? 'visit-dialog-title-edit' : 'visit-dialog-title-create'"
    cdkTrapFocus
    [cdkTrapFocusAutoCapture]="open"
  >
    <header class="visit-dialog__header">
      <div class="visit-dialog__header-main">
        <span class="visit-dialog__badge" aria-hidden="true">
          <mat-icon>{{ editedVisitId ? 'edit' : 'add' }}</mat-icon>
        </span>
        <div class="visit-dialog__title-wrap">
          <h2 [id]="editedVisitId ? 'visit-dialog-title-edit' : 'visit-dialog-title-create'">
            {{ editedVisitId ? 'Редагування візиту' : 'Новий візит' }}
          </h2>
          <p>{{ editedVisitId ? 'Оновіть дані прийому пацієнта' : 'Додайте інформацію про прийом пацієнта' }}</p>
        </div>
      </div>
      <button
        mat-icon-button
        type="button"
        aria-label="Закрити форму"
        class="visit-dialog__close"
        (click)="closeDialog()"
      >
        <mat-icon>close</mat-icon>
      </button>
    </header>

    <form [formGroup]="visitForm" (ngSubmit)="submitForm()" class="visit-form visit-form--dialog">
      <div class="visit-form__rows">
        <div class="visit-form__row">
          <mat-form-field appearance="outline" class="modern-field compact-field" subscriptSizing="dynamic">
            <mat-label>ПІБ пацієнта</mat-label>
            <input #patientNameInput matInput formControlName="patientName" autocomplete="name" />
            <mat-error *ngIf="patientNameControl?.touched && patientNameControl?.invalid">
              Вкажіть ПІБ пацієнта
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="modern-field compact-field" subscriptSizing="dynamic">
            <mat-label>Послуга</mat-label>
            <mat-select formControlName="procedureName" (selectionChange)="applyProcedureDefaultPercent($event)">
              <mat-option *ngFor="let option of procedureOptions" [value]="option">
                {{ option }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="procedureNameControl?.touched && procedureNameControl?.invalid">
              Вкажіть назву послуги
            </mat-error>
          </mat-form-field>
        </div>

        <div class="visit-form__row">
          <mat-form-field appearance="outline" class="modern-field compact-field" subscriptSizing="dynamic">
            <mat-label>Дата</mat-label>
            <input
              matInput
              [matDatepicker]="visitDatePicker"
              [max]="maxVisitDate"
              formControlName="visitDate"
              readonly
              (click)="visitDatePicker.open()"
            />
            <mat-datepicker-toggle matSuffix [for]="visitDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #visitDatePicker [startAt]="maxVisitDate"></mat-datepicker>
            <mat-error *ngIf="visitDateControl?.touched && visitDateControl?.invalid"> Вкажіть дату візиту </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="modern-field compact-field" subscriptSizing="dynamic">
            <mat-label>Сума, грн</mat-label>
            <input #amountInput matInput type="number" min="1" step="1" formControlName="amount" inputmode="decimal" />
            <mat-error *ngIf="amountControl?.touched && amountControl?.invalid"> Сума має бути більше 0 </mat-error>
          </mat-form-field>
        </div>

        <div class="visit-form__row visit-form__row--finance">
          <div class="percent-stack">
            <mat-form-field appearance="outline" class="modern-field compact-field" subscriptSizing="dynamic">
              <mat-label>Відсоток</mat-label>
              <input
                matInput
                type="number"
                min="0"
                max="100"
                step="0.5"
                formControlName="percent"
                inputmode="decimal"
              />
              <mat-error *ngIf="percentControl?.touched && percentControl?.invalid"> Допустимо від 0 до 100 </mat-error>
            </mat-form-field>

            <div class="percent-quick" aria-label="Швидкий вибір відсотка">
              <button
                type="button"
                class="percent-quick__btn"
                *ngFor="let quickPercent of percentQuickOptions"
                [class.percent-quick__btn--active]="isQuickPercentActive(quickPercent)"
                (click)="applyQuickPercent(quickPercent)"
              >
                {{ quickPercent }}%
              </button>
            </div>
          </div>

          <mat-form-field appearance="outline" class="modern-field compact-field" subscriptSizing="dynamic">
            <mat-label>Очікуваний дохід</mat-label>
            <input
              matInput
              type="text"
              [value]="projectedIncome | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA'"
              readonly
              tabindex="-1"
            />
          </mat-form-field>
        </div>
      </div>

      <div class="form-actions">
        <button mat-button type="button" (click)="closeDialog()" [disabled]="saving" class="secondary-action">
          Скасувати
        </button>

        <button
          mat-flat-button
          color="primary"
          type="submit"
          [disabled]="saving || visitForm.invalid"
          class="primary-action"
        >
          Зберегти
        </button>
      </div>
    </form>
  </mat-card>
</div>
