<mat-card class="panel ledger">
  <!-- ── Header ──────────────────────────────────────────────────────── -->
  <header class="ledger__header">
    <div class="ledger__title-row">
      <div class="ledger__title-group">
        <span class="ledger__badge">
          <mat-icon>content_paste</mat-icon>
        </span>
        <div class="ledger__title-info">
          <h2>Журнал візитів</h2>
          <div class="ledger__subtitle">
            <span class="ledger__period" *ngIf="selectedMonthLabel">{{ selectedMonthLabel }}</span>
            <ng-container *ngIf="!monthLoading">
              <span class="ledger__count" *ngIf="!ledgerVm.hasQuery">{{ totalVisits }} записів</span>
              <span class="ledger__count" *ngIf="ledgerVm.hasQuery"
                >{{ ledgerVm.visits.length }} з {{ totalVisits }}</span
              >
            </ng-container>
            <span class="skeleton-inline" *ngIf="monthLoading"></span>
          </div>
        </div>
      </div>

      <button mat-flat-button color="primary" type="button" class="ledger__cta" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon>
        Новий візит
      </button>
    </div>

    <!-- ── Controls ─────────────────────────────────────────────────── -->
    <div class="ledger__controls">
      <div class="ledger__search">
        <mat-icon class="ledger__search-icon">search</mat-icon>
        <input
          class="ledger__search-input"
          type="text"
          placeholder="Пошук за пацієнтом, послугою, датою…"
          [formControl]="searchControl"
          autocomplete="off"
        />
        <button
          *ngIf="searchControl.value"
          type="button"
          class="ledger__search-clear"
          (click)="clearSearch()"
          aria-label="Очистити"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="ledger__sort">
        <mat-icon class="ledger__sort-icon">swap_vert</mat-icon>
        <select class="ledger__sort-select" [formControl]="sortControl" aria-label="Сортування">
          <option value="dateDesc">Найновіші спочатку</option>
          <option value="incomeDesc">Дохід: більше до менше</option>
          <option value="amountDesc">Сума: більше до менше</option>
          <option value="patientAsc">Пацієнт: А–Я</option>
        </select>
        <mat-icon class="ledger__sort-arrow">keyboard_arrow_down</mat-icon>
      </div>
    </div>
  </header>

  <div class="ledger-skeleton" *ngIf="monthLoading">
    <div class="skeleton-line skeleton-line--long"></div>
    <div class="skeleton-line skeleton-line--long"></div>
    <div class="skeleton-line skeleton-line--long"></div>
    <div class="skeleton-line skeleton-line--long"></div>
  </div>

  <div class="table-wrap" *ngIf="!monthLoading && ledgerVm.visits.length">
    <div class="table-wrap__desktop">
      <table mat-table [dataSource]="pagedVisits" class="visits-table">
        <ng-container matColumnDef="visitDate">
          <th mat-header-cell *matHeaderCellDef>Дата</th>
          <td mat-cell *matCellDef="let visit">
            <span class="visit-date">
              <strong>{{ visit.visitDate + 'T00:00:00' | date: 'dd' : '' : 'uk-UA' }}</strong>
              <span>{{ visit.visitDate + 'T00:00:00' | date: 'MMM' : '' : 'uk-UA' }}</span>
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="patientName">
          <th mat-header-cell *matHeaderCellDef>Пацієнт</th>
          <td mat-cell *matCellDef="let visit">
            <div class="patient-cell">
              <span class="patient-avatar patient-avatar--{{ visit.patientName.charCodeAt(0) % 5 }}">{{
                visit.patientName[0]?.toUpperCase()
              }}</span>
              {{ visit.patientName }}
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="procedureName">
          <th mat-header-cell *matHeaderCellDef>Послуга</th>
          <td mat-cell *matCellDef="let visit">
            <span class="visit-procedure" [ngClass]="procedureClass(visit.procedureName)">{{
              visit.procedureName
            }}</span>
            <small *ngIf="visit.notes">{{ visit.notes }}</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Сума</th>
          <td mat-cell *matCellDef="let visit">
            {{ visit.amount | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="percent">
          <th mat-header-cell *matHeaderCellDef>%</th>
          <td mat-cell *matCellDef="let visit">
            <div class="percent-cell">
              <div class="percent-bar"><div class="percent-bar__fill" [style.width.%]="visit.percent"></div></div>
              <span>{{ visit.percent | number: '1.0-0' }}%</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="doctorIncome">
          <th mat-header-cell *matHeaderCellDef>Дохід</th>
          <td mat-cell *matCellDef="let visit">
            {{ visit.doctorIncome | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Дії</th>
          <td mat-cell *matCellDef="let visit">
            <div class="row-actions">
              <button
                mat-icon-button
                type="button"
                class="row-menu-btn"
                [matMenuTriggerFor]="rowMenu"
                [matMenuTriggerData]="{ visit: visit }"
                (click)="$event.stopPropagation()"
                aria-label="Дії"
              >
                <mat-icon>more_vert</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="visits-table__row"
          tabindex="0"
          role="button"
          [attr.aria-label]="'Редагувати візит ' + row.patientName"
          (click)="editVisit(row)"
          (keydown.enter)="editVisit(row)"
          (keydown.space)="editVisit(row); $event.preventDefault()"
        ></tr>
      </table>
    </div>

    <!-- Row context menu -->
    <mat-menu #rowMenu="matMenu" class="ledger-row-menu">
      <ng-template matMenuContent let-visit="visit">
        <button
          mat-menu-item
          class="ledger-row-menu__delete"
          [disabled]="deletingId === visit.id"
          (click)="deleteVisit(visit)"
        >
          <mat-icon>delete_outline</mat-icon>
          Видалити
        </button>
      </ng-template>
    </mat-menu>

    <div class="visits-mobile">
      <article
        class="visit-card"
        *ngFor="let visit of pagedVisits; trackBy: trackByVisitId"
        tabindex="0"
        role="button"
        [attr.aria-label]="'Редагувати візит ' + visit.patientName"
        (click)="editVisit(visit)"
        (keydown.enter)="editVisit(visit)"
        (keydown.space)="editVisit(visit); $event.preventDefault()"
      >
        <div class="visit-card__head">
          <strong>{{ visit.patientName }}</strong>
          <span>{{ visit.visitDate + 'T00:00:00' | date: 'd MMM' : '' : 'uk-UA' }}</span>
        </div>
        <p class="visit-card__procedure">{{ visit.procedureName }}</p>
        <p class="visit-card__notes" *ngIf="visit.notes">{{ visit.notes }}</p>

        <div class="visit-card__metrics">
          <div>
            <span>Сума</span>
            <strong>{{ visit.amount | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}</strong>
          </div>
          <div>
            <span>Дохід</span>
            <strong>{{ visit.doctorIncome | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}</strong>
          </div>
          <div>
            <span>%</span>
            <strong>{{ visit.percent | number: '1.0-1' }}%</strong>
          </div>
        </div>

        <div class="visit-card__actions">
          <button
            mat-icon-button
            type="button"
            class="row-menu-btn"
            [matMenuTriggerFor]="rowMenu"
            [matMenuTriggerData]="{ visit: visit }"
            (click)="$event.stopPropagation()"
            aria-label="Дії"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
      </article>
    </div>

    <div class="ledger-footer">
      <span class="ledger-footer__count">Показано {{ shownCount }} із {{ totalVisits }} записів</span>
      <button *ngIf="hasMore" type="button" class="ledger-footer__more" (click)="loadMore()">Завантажити ще →</button>
    </div>
  </div>

  <div class="empty-state" *ngIf="!monthLoading && !ledgerVm.visits.length && totalVisits === 0">
    <mat-icon class="empty-state__icon">playlist_add</mat-icon>
    <h3>Поки немає записів</h3>
    <p>Додайте перший прийом, щоб журнал почав формуватись.</p>
    <button
      mat-flat-button
      color="primary"
      type="button"
      class="cta-visit empty-state__cta"
      (click)="openCreateDialog()"
    >
      <mat-icon>add</mat-icon>
      Новий візит
    </button>
  </div>

  <div class="empty-state" *ngIf="!monthLoading && !ledgerVm.visits.length && totalVisits > 0">
    <mat-icon class="empty-state__icon">search_off</mat-icon>
    <h3>Нічого не знайдено</h3>
    <p>Спробуйте змінити пошуковий запит або очистити фільтр.</p>
    <button mat-stroked-button type="button" class="empty-state__cta" (click)="clearSearch()" *ngIf="ledgerVm.hasQuery">
      <mat-icon>restart_alt</mat-icon>
      Очистити пошук
    </button>
  </div>
</mat-card>
