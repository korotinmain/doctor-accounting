<mat-card class="panel ledger">
  <header class="panel__header panel__header--row">
    <div class="panel__title-group">
      <mat-icon class="panel__icon">list_alt</mat-icon>
      <h2>Журнал візитів</h2>
    </div>
    <div class="ledger__header-actions">
      <span class="badge badge--count">
        <ng-container *ngIf="monthLoading">Оновлення...</ng-container>
        <ng-container *ngIf="!monthLoading && ledgerVm.hasQuery; else allCount">
          {{ ledgerVm.visits.length }} з {{ totalVisits }} записів
        </ng-container>
        <ng-template #allCount>
          <ng-container *ngIf="!monthLoading">{{ totalVisits }} записів</ng-container>
        </ng-template>
      </span>
      <button
        mat-flat-button
        color="primary"
        type="button"
        class="cta-visit ledger__add-btn"
        (click)="openCreateDialog()"
      >
        <mat-icon>add</mat-icon>
        Новий візит
      </button>
    </div>
  </header>

  <div class="ledger-controls">
    <mat-form-field appearance="outline" class="modern-field ledger-controls__search" subscriptSizing="dynamic">
      <mat-label>Пошук у журналі</mat-label>
      <mat-icon matPrefix>search</mat-icon>
      <input matInput [formControl]="searchControl" />
      <button
        mat-icon-button
        matSuffix
        type="button"
        *ngIf="searchControl.value"
        (click)="clearSearch()"
        aria-label="Очистити пошук"
      >
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>

    <mat-form-field appearance="outline" class="modern-field ledger-controls__sort" subscriptSizing="dynamic">
      <mat-label>Сортування</mat-label>
      <mat-icon matPrefix>swap_vert</mat-icon>
      <mat-select [formControl]="sortControl">
        <mat-option value="dateDesc">Найновіші спочатку</mat-option>
        <mat-option value="incomeDesc">Дохід: більше до менше</mat-option>
        <mat-option value="amountDesc">Сума: більше до менше</mat-option>
        <mat-option value="patientAsc">Пацієнт: А-Я</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="ledger-skeleton" *ngIf="monthLoading">
    <div class="skeleton-line skeleton-line--long"></div>
    <div class="skeleton-line skeleton-line--long"></div>
    <div class="skeleton-line skeleton-line--long"></div>
    <div class="skeleton-line skeleton-line--long"></div>
  </div>

  <div class="table-wrap" *ngIf="!monthLoading && ledgerVm.visits.length">
    <div class="table-wrap__desktop">
      <table mat-table [dataSource]="ledgerVm.visits" class="visits-table">
        <ng-container matColumnDef="visitDate">
          <th mat-header-cell *matHeaderCellDef>Дата</th>
          <td mat-cell *matCellDef="let visit">
            <span class="visit-date">
              <strong>{{ visit.visitDate + 'T00:00:00' | date: 'dd' : '' : 'uk-UA' }}</strong>
              <span>{{ visit.visitDate + 'T00:00:00' | date: 'MMM' : '' : 'uk-UA' }}</span>
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="patientName">
          <th mat-header-cell *matHeaderCellDef>Пацієнт</th>
          <td mat-cell *matCellDef="let visit">{{ visit.patientName }}</td>
        </ng-container>

        <ng-container matColumnDef="procedureName">
          <th mat-header-cell *matHeaderCellDef>Послуга</th>
          <td mat-cell *matCellDef="let visit">
            <span class="visit-procedure">{{ visit.procedureName }}</span>
            <small *ngIf="visit.notes">{{ visit.notes }}</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Сума</th>
          <td mat-cell *matCellDef="let visit">
            {{ visit.amount | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="percent">
          <th mat-header-cell *matHeaderCellDef>%</th>
          <td mat-cell *matCellDef="let visit">{{ visit.percent | number: '1.0-1' }}%</td>
        </ng-container>

        <ng-container matColumnDef="doctorIncome">
          <th mat-header-cell *matHeaderCellDef>Дохід</th>
          <td mat-cell *matCellDef="let visit">
            {{ visit.doctorIncome | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Дії</th>
          <td mat-cell *matCellDef="let visit">
            <div class="row-actions">
              <button
                mat-icon-button
                type="button"
                color="warn"
                (click)="$event.stopPropagation(); deleteVisit(visit)"
                (keydown.enter)="$event.stopPropagation()"
                (keydown.space)="$event.stopPropagation(); $event.preventDefault()"
                [disabled]="deletingId === visit.id"
                class="row-delete-btn"
                aria-label="Видалити запис"
              >
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="visits-table__row"
          tabindex="0"
          role="button"
          [attr.aria-label]="'Редагувати візит ' + row.patientName"
          (click)="editVisit(row)"
          (keydown.enter)="editVisit(row)"
          (keydown.space)="editVisit(row); $event.preventDefault()"
        ></tr>
      </table>
    </div>

    <div class="visits-mobile">
      <article
        class="visit-card"
        *ngFor="let visit of ledgerVm.visits; trackBy: trackByVisitId"
        tabindex="0"
        role="button"
        [attr.aria-label]="'Редагувати візит ' + visit.patientName"
        (click)="editVisit(visit)"
        (keydown.enter)="editVisit(visit)"
        (keydown.space)="editVisit(visit); $event.preventDefault()"
      >
        <div class="visit-card__head">
          <strong>{{ visit.patientName }}</strong>
          <span>{{ visit.visitDate + 'T00:00:00' | date: 'd MMM' : '' : 'uk-UA' }}</span>
        </div>
        <p class="visit-card__procedure">{{ visit.procedureName }}</p>
        <p class="visit-card__notes" *ngIf="visit.notes">{{ visit.notes }}</p>

        <div class="visit-card__metrics">
          <div>
            <span>Сума</span>
            <strong>{{ visit.amount | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}</strong>
          </div>
          <div>
            <span>Дохід</span>
            <strong>{{ visit.doctorIncome | currency: 'UAH' : 'symbol' : '1.0-0' : 'uk-UA' }}</strong>
          </div>
          <div>
            <span>%</span>
            <strong>{{ visit.percent | number: '1.0-1' }}%</strong>
          </div>
        </div>

        <div class="visit-card__actions">
          <button
            mat-icon-button
            type="button"
            color="warn"
            (click)="$event.stopPropagation(); deleteVisit(visit)"
            (keydown.enter)="$event.stopPropagation()"
            (keydown.space)="$event.stopPropagation(); $event.preventDefault()"
            [disabled]="deletingId === visit.id"
            class="row-delete-btn"
            aria-label="Видалити запис"
          >
            <mat-icon>delete_outline</mat-icon>
          </button>
        </div>
      </article>
    </div>
  </div>

  <div class="empty-state" *ngIf="!monthLoading && !ledgerVm.visits.length && totalVisits === 0">
    <mat-icon class="empty-state__icon">playlist_add</mat-icon>
    <h3>Поки немає записів</h3>
    <p>Додайте перший прийом, щоб журнал почав формуватись.</p>
    <button
      mat-flat-button
      color="primary"
      type="button"
      class="cta-visit empty-state__cta"
      (click)="openCreateDialog()"
    >
      <mat-icon>add</mat-icon>
      Новий візит
    </button>
  </div>

  <div class="empty-state" *ngIf="!monthLoading && !ledgerVm.visits.length && totalVisits > 0">
    <mat-icon class="empty-state__icon">search_off</mat-icon>
    <h3>Нічого не знайдено</h3>
    <p>Спробуйте змінити пошуковий запит або очистити фільтр.</p>
    <button mat-stroked-button type="button" class="empty-state__cta" (click)="clearSearch()" *ngIf="ledgerVm.hasQuery">
      <mat-icon>restart_alt</mat-icon>
      Очистити пошук
    </button>
  </div>
</mat-card>
