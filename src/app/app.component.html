<div class="shell" *ngIf="vm$ | async as vm; else loadingState">
  <header class="top">
    <div class="top__brand">
      <div class="top__logo">
        <mat-icon class="brand-icon">medical_services</mat-icon>
      </div>
      <div>
        <p class="top__eyebrow">Doctor Accounting</p>
        <h1>Облік прийомів</h1>
      </div>
    </div>

    <div class="top__month">
      <div class="top__month-head">
        <p class="top__month-label">Місяць звіту</p>
        <button
          mat-stroked-button
          type="button"
          class="top__month-today"
          (click)="goCurrentMonth()"
        >
          <mat-icon>today</mat-icon>
          Сьогодні
        </button>
      </div>
      <div class="month-switcher" role="group" aria-label="Вибір місяця звіту">
        <button
          mat-icon-button
          type="button"
          class="month-switcher__btn"
          (click)="shiftMonth(-1)"
          aria-label="Попередній місяць"
        >
          <mat-icon>chevron_left</mat-icon>
        </button>

        <div class="month-switcher__center">
          <p class="month-switcher__value">{{ selectedMonthLabel }}</p>
        </div>

        <button
          mat-icon-button
          type="button"
          class="month-switcher__btn"
          (click)="shiftMonth(1)"
          aria-label="Наступний місяць"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
  </header>

  <section class="auth-alert" *ngIf="authErrorMessage">
    <mat-icon>warning_amber</mat-icon>
    <p>{{ authErrorMessage }}</p>
  </section>

  <ng-container *ngIf="{ monthLoading: (monthLoading$ | async) ?? true } as view">
  <section class="stats" *ngIf="!view.monthLoading; else statsLoading">
    <mat-card class="stat stat--income">
      <div class="stat__icon-wrapper stat__icon-wrapper--primary">
        <mat-icon>account_balance_wallet</mat-icon>
      </div>
      <div class="stat__content">
        <span>Дохід лікаря</span>
        <strong>{{
          vm.summary.totalIncome
            | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA"
        }}</strong>
      </div>
    </mat-card>

    <mat-card class="stat">
      <div class="stat__icon-wrapper">
        <mat-icon>payments</mat-icon>
      </div>
      <div class="stat__content">
        <span>Загальна каса</span>
        <strong>{{
          vm.summary.totalAmount
            | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA"
        }}</strong>
      </div>
    </mat-card>

    <mat-card class="stat">
      <div class="stat__icon-wrapper">
        <mat-icon>event_available</mat-icon>
      </div>
      <div class="stat__content">
        <span>Прийомів</span>
        <strong>{{ vm.summary.totalVisits }}</strong>
      </div>
    </mat-card>

    <mat-card class="stat">
      <div class="stat__icon-wrapper">
        <mat-icon>people</mat-icon>
      </div>
      <div class="stat__content">
        <span>Пацієнтів</span>
        <strong>{{ vm.summary.uniquePatients }}</strong>
      </div>
    </mat-card>

  </section>

  <ng-template #statsLoading>
    <section class="stats stats--skeleton">
      <mat-card class="stat stat--skeleton">
        <div class="skeleton-line skeleton-line--short"></div>
        <div class="skeleton-line skeleton-line--value"></div>
      </mat-card>
      <mat-card class="stat stat--skeleton">
        <div class="skeleton-line skeleton-line--short"></div>
        <div class="skeleton-line skeleton-line--value"></div>
      </mat-card>
      <mat-card class="stat stat--skeleton">
        <div class="skeleton-line skeleton-line--short"></div>
        <div class="skeleton-line skeleton-line--value"></div>
      </mat-card>
      <mat-card class="stat stat--skeleton">
        <div class="skeleton-line skeleton-line--short"></div>
        <div class="skeleton-line skeleton-line--value"></div>
      </mat-card>
    </section>
  </ng-template>

  <section class="content-grid">
    <mat-card class="panel action-panel">
      <header class="panel__header panel__header--row">
        <div class="panel__title-group">
          <mat-icon class="panel__icon">add_task</mat-icon>
          <div>
            <h2>Керування записами</h2>
            <p>Створюйте або редагуйте візити через окреме діалогове вікно.</p>
          </div>
        </div>
        <button
          mat-flat-button
          color="primary"
          type="button"
          class="primary-action action-panel__btn"
          (click)="openCreateDialog()"
        >
          <mat-icon>add_circle</mat-icon>
          Новий візит
        </button>
      </header>

      <div class="action-panel__meta">
        <div class="action-chip">
          <mat-icon>calendar_month</mat-icon>
          <span>Період: <strong>{{ selectedMonthLabel }}</strong></span>
        </div>
        <div class="action-chip">
          <mat-icon>query_stats</mat-icon>
          <span
            >Візитів:
            <strong *ngIf="!view.monthLoading; else visitsChipSkeleton">{{
              vm.summary.totalVisits
            }}</strong></span
          >
        </div>
      </div>

      <ng-template #visitsChipSkeleton>
        <span class="skeleton-inline"></span>
      </ng-template>
    </mat-card>

    <div class="side-stack">
      <mat-card class="panel mini mini--summary">
        <header class="mini__header">
          <div class="mini__title-group">
            <mat-icon class="mini__icon">summarize</mat-icon>
            <h3>Підсумок місяця</h3>
          </div>
          <span class="mini__period">{{ selectedMonthLabel }}</span>
        </header>

        <div class="summary-grid">
          <article class="summary-item">
            <span>Прийомів</span>
            <strong *ngIf="!view.monthLoading; else summaryVisitsSkeleton">{{
              vm.summary.totalVisits
            }}</strong>
          </article>

          <article class="summary-item summary-item--income">
            <span>Дохід лікаря</span>
            <strong *ngIf="!view.monthLoading; else summaryIncomeSkeleton">{{
              vm.summary.totalIncome
                | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA"
            }}</strong>
          </article>
        </div>

        <ng-template #summaryVisitsSkeleton>
          <span class="skeleton-inline skeleton-inline--lg"></span>
        </ng-template>
        <ng-template #summaryIncomeSkeleton>
          <span class="skeleton-inline skeleton-inline--lg"></span>
        </ng-template>
      </mat-card>

      <mat-card class="panel mini">
        <header class="mini__header">
          <div class="mini__title-group">
            <mat-icon class="mini__icon">emoji_events</mat-icon>
            <h3>Найсильніші дні</h3>
          </div>
          <span class="badge">ТОП 5</span>
        </header>

        <div class="top-days" *ngIf="!view.monthLoading && vm.topDays.length; else topDaysState">
          <div class="top-days__row" *ngFor="let day of vm.topDays">
            <div>
              <strong>{{
                day.date + "T00:00:00" | date: "d MMM" : "" : "uk-UA"
              }}</strong>
              <small>{{ day.visits }} візит(ів)</small>
            </div>
            <strong class="top-days__income">{{
              day.income | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA"
            }}</strong>
          </div>
        </div>

        <ng-template #topDaysState>
          <div class="top-days top-days--skeleton" *ngIf="view.monthLoading; else emptyTopDays">
            <div class="top-days__row top-days__row--skeleton"></div>
            <div class="top-days__row top-days__row--skeleton"></div>
            <div class="top-days__row top-days__row--skeleton"></div>
          </div>
        </ng-template>

        <ng-template #emptyTopDays>
          <p class="muted">Ще немає даних для порівняння днів.</p>
        </ng-template>
      </mat-card>
    </div>

    <mat-card class="panel ledger" *ngIf="ledgerVm$ | async as ledgerVm">
    <header class="panel__header panel__header--row">
      <div class="panel__title-group">
        <mat-icon class="panel__icon">list_alt</mat-icon>
        <h2>Журнал візитів</h2>
      </div>
      <div class="ledger__header-actions">
        <span class="badge badge--count">
          <ng-container *ngIf="view.monthLoading">Оновлення...</ng-container>
          <ng-container *ngIf="!view.monthLoading && ledgerVm.hasQuery; else allCount">
            {{ ledgerVm.visits.length }} з {{ vm.summary.totalVisits }} записів
          </ng-container>
          <ng-template #allCount>
            <ng-container *ngIf="!view.monthLoading">{{ vm.summary.totalVisits }} записів</ng-container>
          </ng-template>
        </span>
        <button
          mat-flat-button
          color="primary"
          type="button"
          class="ledger__add-btn"
          (click)="openCreateDialog()"
        >
          <mat-icon>add</mat-icon>
          Додати
        </button>
      </div>
    </header>

    <div class="ledger-controls">
      <mat-form-field
        appearance="outline"
        class="modern-field ledger-controls__search"
        subscriptSizing="dynamic"
      >
        <mat-label>Пошук у журналі</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input
          matInput
          [formControl]="searchControl"
        />
        <button
          mat-icon-button
          matSuffix
          type="button"
          *ngIf="searchControl.value"
          (click)="clearSearch()"
          aria-label="Очистити пошук"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        class="modern-field ledger-controls__sort"
        subscriptSizing="dynamic"
      >
        <mat-label>Сортування</mat-label>
        <mat-icon matPrefix>swap_vert</mat-icon>
        <mat-select [formControl]="sortControl">
          <mat-option value="dateDesc">Найновіші спочатку</mat-option>
          <mat-option value="incomeDesc">Дохід: більше до менше</mat-option>
          <mat-option value="amountDesc">Сума: більше до менше</mat-option>
          <mat-option value="patientAsc">Пацієнт: А-Я</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="ledger-skeleton" *ngIf="view.monthLoading">
      <div class="skeleton-line skeleton-line--long"></div>
      <div class="skeleton-line skeleton-line--long"></div>
      <div class="skeleton-line skeleton-line--long"></div>
      <div class="skeleton-line skeleton-line--long"></div>
    </div>

    <div class="table-wrap" *ngIf="!view.monthLoading && ledgerVm.visits.length">
      <div class="table-wrap__desktop">
        <table mat-table [dataSource]="ledgerVm.visits" class="visits-table">
          <ng-container matColumnDef="visitDate">
            <th mat-header-cell *matHeaderCellDef>Дата</th>
            <td mat-cell *matCellDef="let visit">
              {{ visit.visitDate + "T00:00:00" | date: "d MMM" : "" : "uk-UA" }}
            </td>
          </ng-container>

          <ng-container matColumnDef="patientName">
            <th mat-header-cell *matHeaderCellDef>Пацієнт</th>
            <td mat-cell *matCellDef="let visit">{{ visit.patientName }}</td>
          </ng-container>

          <ng-container matColumnDef="procedureName">
            <th mat-header-cell *matHeaderCellDef>Послуга</th>
            <td mat-cell *matCellDef="let visit">
              <span>{{ visit.procedureName }}</span>
              <small *ngIf="visit.notes">{{ visit.notes }}</small>
            </td>
          </ng-container>

          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Сума</th>
            <td mat-cell *matCellDef="let visit">
              {{ visit.amount | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA" }}
            </td>
          </ng-container>

          <ng-container matColumnDef="percent">
            <th mat-header-cell *matHeaderCellDef>%</th>
            <td mat-cell *matCellDef="let visit">
              {{ visit.percent | number: "1.0-1" }}%
            </td>
          </ng-container>

          <ng-container matColumnDef="doctorIncome">
            <th mat-header-cell *matHeaderCellDef>Дохід</th>
            <td mat-cell *matCellDef="let visit">
              {{
                visit.doctorIncome
                  | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA"
              }}
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Дії</th>
            <td mat-cell *matCellDef="let visit">
              <div class="row-actions">
                <button
                  mat-icon-button
                  type="button"
                  color="warn"
                  (click)="$event.stopPropagation(); deleteVisit(visit)"
                  (keydown.enter)="$event.stopPropagation()"
                  (keydown.space)="$event.stopPropagation(); $event.preventDefault()"
                  [disabled]="deletingId === visit.id"
                  class="row-delete-btn"
                  aria-label="Видалити запис"
                >
                  <mat-icon>delete_outline</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: displayedColumns;
              trackBy: trackByVisitId
            "
            class="visits-table__row"
            tabindex="0"
            role="button"
            [attr.aria-label]="'Редагувати візит ' + row.patientName"
            (click)="editVisit(row)"
            (keydown.enter)="editVisit(row)"
            (keydown.space)="editVisit(row); $event.preventDefault()"
          ></tr>
        </table>
      </div>

      <div class="visits-mobile">
        <article
          class="visit-card"
          *ngFor="let visit of ledgerVm.visits; trackBy: trackByVisitId"
          tabindex="0"
          role="button"
          [attr.aria-label]="'Редагувати візит ' + visit.patientName"
          (click)="editVisit(visit)"
          (keydown.enter)="editVisit(visit)"
          (keydown.space)="editVisit(visit); $event.preventDefault()"
        >
          <div class="visit-card__head">
            <strong>{{ visit.patientName }}</strong>
            <span>{{ visit.visitDate + "T00:00:00" | date: "d MMM" : "" : "uk-UA" }}</span>
          </div>
          <p class="visit-card__procedure">{{ visit.procedureName }}</p>
          <p class="visit-card__notes" *ngIf="visit.notes">{{ visit.notes }}</p>

          <div class="visit-card__metrics">
            <div>
              <span>Сума</span>
              <strong>{{ visit.amount | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA" }}</strong>
            </div>
            <div>
              <span>Дохід</span>
              <strong>{{ visit.doctorIncome | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA" }}</strong>
            </div>
            <div>
              <span>%</span>
              <strong>{{ visit.percent | number: "1.0-1" }}%</strong>
            </div>
          </div>

          <div class="visit-card__actions">
            <button
              mat-icon-button
              type="button"
              color="warn"
              (click)="$event.stopPropagation(); deleteVisit(visit)"
              (keydown.enter)="$event.stopPropagation()"
              (keydown.space)="$event.stopPropagation(); $event.preventDefault()"
              [disabled]="deletingId === visit.id"
              class="row-delete-btn"
              aria-label="Видалити запис"
            >
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </article>
      </div>
    </div>

    <div class="empty-state" *ngIf="!view.monthLoading && !ledgerVm.visits.length && vm.summary.totalVisits === 0">
      <mat-icon class="empty-state__icon">playlist_add</mat-icon>
      <h3>Поки немає записів</h3>
      <p>Додайте перший прийом, щоб журнал почав формуватись.</p>
      <button mat-flat-button color="primary" type="button" class="empty-state__cta" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon>
        Новий візит
      </button>
    </div>

    <div class="empty-state" *ngIf="!view.monthLoading && !ledgerVm.visits.length && vm.summary.totalVisits > 0">
      <mat-icon class="empty-state__icon">search_off</mat-icon>
      <h3>Нічого не знайдено</h3>
      <p>Спробуйте змінити пошуковий запит або очистити фільтр.</p>
      <button mat-stroked-button type="button" class="empty-state__cta" (click)="clearSearch()" *ngIf="ledgerVm.hasQuery">
        <mat-icon>restart_alt</mat-icon>
        Очистити пошук
      </button>
    </div>
  </mat-card>
  </section>
  </ng-container>

  <div
    class="dialog-overlay"
    *ngIf="formDialogOpen"
    (click)="closeVisitDialog()"
  >
    <mat-card class="panel visit-dialog" (click)="$event.stopPropagation()">
      <header class="visit-dialog__header">
        <div class="panel__title-group">
          <mat-icon class="panel__icon">{{
            editedVisitId ? "edit_note" : "add_circle_outline"
          }}</mat-icon>
          <div>
            <h2>{{ editedVisitId ? "Редагування візиту" : "Новий візит" }}</h2>
            <p>Внесіть дані пацієнта та фінансову інформацію.</p>
          </div>
        </div>
        <button
          mat-icon-button
          type="button"
          aria-label="Закрити форму"
          class="visit-dialog__close"
          (click)="closeVisitDialog()"
        >
          <mat-icon>close</mat-icon>
        </button>
      </header>

      <form
        [formGroup]="visitForm"
        (ngSubmit)="submitVisit()"
        class="visit-form visit-form--dialog"
      >
        <div class="form-grid">
          <div class="form-section-title full">
            <h3>Пацієнт</h3>
            <p>Базова інформація про пацієнта і тип послуги.</p>
          </div>

          <mat-form-field
            appearance="outline"
            class="full modern-field"
            subscriptSizing="dynamic"
          >
            <mat-label>ПІБ пацієнта</mat-label>
            <mat-icon matPrefix>person</mat-icon>
            <input #patientNameInput matInput formControlName="patientName" />
            <mat-error
              *ngIf="
                visitForm.controls.patientName.touched &&
                visitForm.controls.patientName.invalid
              "
            >
              Вкажіть ПІБ пацієнта
            </mat-error>
          </mat-form-field>

          <mat-form-field
            appearance="outline"
            class="full modern-field"
            subscriptSizing="dynamic"
          >
            <mat-label>Послуга</mat-label>
            <mat-icon matPrefix>medical_services</mat-icon>
            <mat-select formControlName="procedureName">
              <mat-option *ngFor="let option of procedureOptions" [value]="option">
                {{ option }}
              </mat-option>
            </mat-select>
            <mat-error
              *ngIf="
                visitForm.controls.procedureName.touched &&
                visitForm.controls.procedureName.invalid
              "
            >
              Вкажіть назву послуги
            </mat-error>
          </mat-form-field>

          <div class="form-section-title full">
            <h3>Фінанси</h3>
            <p>Дата, сума і відсоток лікаря для розрахунку доходу.</p>
          </div>

          <mat-form-field
            appearance="outline"
            class="modern-field"
            subscriptSizing="dynamic"
          >
            <mat-label>Дата</mat-label>
            <mat-icon matPrefix>event</mat-icon>
            <input matInput type="date" formControlName="visitDate" />
            <mat-error
              *ngIf="
                visitForm.controls.visitDate.touched &&
                visitForm.controls.visitDate.invalid
              "
            >
              Вкажіть дату візиту
            </mat-error>
          </mat-form-field>

          <mat-form-field
            appearance="outline"
            class="modern-field"
            subscriptSizing="dynamic"
          >
            <mat-label>Сума, грн</mat-label>
            <mat-icon matPrefix>attach_money</mat-icon>
            <input
              #amountInput
              matInput
              type="number"
              min="1"
              step="1"
              formControlName="amount"
            />
            <mat-error
              *ngIf="
                visitForm.controls.amount.touched &&
                visitForm.controls.amount.invalid
              "
            >
              Сума має бути більше 0
            </mat-error>
          </mat-form-field>

          <div class="percent-control">
            <mat-form-field
              appearance="outline"
              class="modern-field"
              subscriptSizing="dynamic"
            >
              <mat-label>Відсоток лікаря</mat-label>
              <mat-icon matPrefix>percent</mat-icon>
              <input
                matInput
                type="number"
                min="0"
                max="100"
                step="0.5"
                formControlName="percent"
              />
              <mat-error
                *ngIf="
                  visitForm.controls.percent.touched &&
                  visitForm.controls.percent.invalid
                "
              >
                Допустимо від 0 до 100
              </mat-error>
            </mat-form-field>

            <div class="percent-quick" aria-label="Швидкий вибір відсотка">
              <button
                type="button"
                class="percent-quick__btn"
                *ngFor="let quickPercent of percentQuickOptions"
                [class.percent-quick__btn--active]="visitForm.controls.percent.value === quickPercent"
                (click)="applyQuickPercent(quickPercent)"
              >
                {{ quickPercent }}%
              </button>
            </div>
          </div>

          <div class="income-preview income-preview--sticky">
            <mat-icon class="income-preview__icon">monetization_on</mat-icon>
            <div class="income-preview__content">
              <span>Очікуваний дохід</span>
              <strong>{{
                projectedIncome$
                  | async
                  | currency: "UAH" : "symbol" : "1.0-0" : "uk-UA"
              }}</strong>
            </div>
          </div>

          <div class="form-section-title full">
            <h3>Додатково</h3>
            <p>Коментарі або примітки до прийому.</p>
          </div>

          <mat-form-field
            appearance="outline"
            class="full modern-field"
            subscriptSizing="dynamic"
          >
            <mat-label>Примітки</mat-label>
            <mat-icon matPrefix>description</mat-icon>
            <textarea matInput rows="2" formControlName="notes"></textarea>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button
            mat-stroked-button
            type="button"
            (click)="closeVisitDialog()"
            [disabled]="saving"
            class="secondary-action"
          >
            <mat-icon>close</mat-icon>
            Закрити
          </button>

          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="saving || visitForm.invalid"
            class="primary-action"
          >
            <mat-icon>{{
              editedVisitId ? "check_circle" : "add_circle"
            }}</mat-icon>
            {{ editedVisitId ? "Оновити запис" : "Додати запис" }}
          </button>
        </div>
      </form>
    </mat-card>
  </div>
</div>

<ng-template #loadingState>
  <div class="shell shell--loading">
    <section class="loading loading--hero"></section>
    <section class="loading-grid">
      <article class="loading"></article>
      <article class="loading"></article>
      <article class="loading"></article>
      <article class="loading"></article>
    </section>
    <section class="loading loading--panel"></section>
  </div>
</ng-template>
